# DocPortal - Product Requirements Document

## Original Problem Statement
Build a clone of SimplePractice (practice management platform for healthcare professionals), rebranded as "DocPortal".

## Core Requirements
- **Dual Interface**: Provider Dashboard + Client Portal
- **Authentication**: JWT (email/password) + Google OAuth with role selection
- **Doctor-Centric Architecture**: Providers invite clients, not vice versa
- **Core Features**: Appointments, Messaging, Billing (Stripe), Video Consultations
- **Internationalization**: 8 European languages (EN, SL, DE, FR, ES, IT, PT, NL)
- **Theming**: Light/Dark mode toggle
- **HIPAA Compliance**: Basic security features

## Architecture

### Authentication Model (NEW - Jan 27, 2025)
- **Two Separate Login Systems**: Provider Portal and Client Portal
- **Provider Registration**: Self-service via email/password or Google OAuth
- **Client Registration**: ONLY via invite code from a provider
- **Invite Code System**: 8-character codes generated by providers, single-use, expiring

### Tech Stack
- **Frontend**: React + Tailwind CSS + shadcn/ui + i18next
- **Backend**: FastAPI + MongoDB (Motor)
- **Auth**: JWT + Google OAuth via Emergent Auth

## What's Been Implemented

### Completed (Jan 27, 2025 - Phase 2: Doctor-Centric Auth)
- [x] **Separate Login Pages**: `/provider/login` and `/client/login`
- [x] **Provider Registration**: `/provider/register` with Google OAuth support
- [x] **Invite Code System**: Providers generate codes, clients register with codes
- [x] **Invite Code Validation**: Real-time validation showing provider info
- [x] **Client-Provider Binding**: Each client linked to exactly one provider
- [x] **Updated Landing Page**: Two distinct cards for Provider and Client
- [x] **Provider Dashboard**: Added "Invite Client" button with modal
- [x] **Removed Provider Browse**: Clients cannot search for providers

### API Endpoints (Auth & Invite Codes)
- `POST /api/auth/register` - Register provider or client (client requires inviteCode)
- `POST /api/auth/login` - Login with email/password
- `POST /api/auth/google` - Google OAuth (client requires inviteCode for new users)
- `GET /api/auth/validate-invite/{code}` - Validate invite code and get provider info
- `POST /api/provider/invite-code` - Generate new invite code
- `GET /api/provider/invite-codes` - List all provider's invite codes
- `DELETE /api/provider/invite-codes/{code}` - Delete unused invite code

### Previous Implementations (Jan 27, 2025 - Phase 1)
- [x] Application rebranding to "DocPortal"
- [x] JWT authentication (login/register)
- [x] Google OAuth with role selection (Provider/Client)
- [x] Dark/Light theme toggle
- [x] i18n support for 8 languages
- [x] Provider Dashboard - Connected to live API
- [x] Client Portal - Connected to live API
- [x] Backend API routes for auth, appointments, messages, billing

## Current Status
- **Backend**: 100% working (all new endpoints tested)
- **Frontend**: 100% working (separate login pages, invite code flow)
- **Integration**: Full doctor-centric auth flow working end-to-end

## Recent Updates (Dec 2025)
### Frontend ESLint Issues Fixed
- **ProviderDashboard.jsx**: Refactored nested `NavItems` component into data-driven `renderNavItems()` function
- **AppointmentBooking.jsx**: `useEffect` hooks dependency arrays verified as compliant
- **ScheduleSettings.jsx**: `useEffect` hook dependency array verified as compliant
- **ClientPortal.jsx**: `useEffect` hook dependency array verified as compliant, fixed unescaped apostrophe
- **All files**: Fixed unescaped apostrophe characters (Today's → Today&apos;s, You're → You&apos;re)

### Session Security & Payment Features (Jan 2026)
- **Auto-logout**: 30 minutes of inactivity triggers automatic logout
- **Keep me logged in**: Checkbox option with security warning (persistent session)
- **Session timeout hook**: `useSessionTimeout.js` monitors user activity
- **Provider Business Settings**: EU/Slovenian invoice compliance
  - Business name, address, tax number (davčna številka)
  - VAT ID (DDV), registration number
  - Bank details (IBAN, BIC/SWIFT)
  - Logo upload capability
- **PDF Invoice Generation**: European compliant invoices with:
  - Provider branding and details
  - Client information
  - Net amount, VAT (22% Slovenia), gross total
  - Payment instructions and bank details
- **Refund System**:
  - Patients can request refunds 3+ days before appointment
  - Must provide reason in text box
  - Providers approve/reject with optional response
  - Full refund processed via Stripe upon approval
  - Appointment automatically cancelled

## User Flows

### Provider Onboarding
1. Go to `/provider/login` or `/provider/register`
2. Register with email/password OR Google OAuth
3. Access dashboard
4. Generate invite codes for clients

### Client Onboarding
1. Receive invite code from provider (8-character code)
2. Go to `/client/login` and click "Have Invite Code?"
3. Enter invite code → See provider info
4. Register with email/password OR Google OAuth
5. Automatically linked to provider
6. Access client portal

## Known Limitations
- **Stripe**: Uses test/placeholder keys (MOCKED payment flow - no real charges)
- **Google Meet**: Placeholder links generated (format: meet.google.com/xxx-yyyy-zzz)
- **Google OAuth**: May show 403 on first use (Emergent Auth needs domain registration)

## Pending Tasks (P1)
1. Full EHR/Notes UI implementation
2. Real video call integration (Google Meet API or alternative)

## Future Tasks (P2)
1. Comprehensive unit/integration tests
2. Email notifications integration
3. Production deployment configuration
4. Real Stripe integration with webhook handling

## Test Credentials
- **Provider**: testprovider_xxx@example.com / TestPass123!
- **Client**: testclient_xxx@example.com / TestPass123!
- **API URL**: https://portal-test-hub.preview.emergentagent.com

## Key Files
- `/app/frontend/src/components/ProviderLogin.jsx` - Provider login page
- `/app/frontend/src/components/ClientLogin.jsx` - Client login page
- `/app/frontend/src/components/ProviderRegister.jsx` - Provider registration
- `/app/frontend/src/components/ClientRegister.jsx` - Client registration with invite code
- `/app/frontend/src/components/ProviderDashboard.jsx` - Provider dashboard with invite modal
- `/app/frontend/src/components/BusinessSettings.jsx` - EU/Slovenia business settings
- `/app/frontend/src/components/RefundManagement.jsx` - Provider refund approval
- `/app/frontend/src/components/RefundRequestModal.jsx` - Client refund request
- `/app/frontend/src/hooks/useSessionTimeout.js` - Auto-logout on inactivity
- `/app/backend/routes/auth_routes.py` - Auth endpoints including invite validation
- `/app/backend/routes/provider_routes.py` - Invite code generation endpoints
- `/app/backend/routes/provider_settings_routes.py` - Business settings & logo upload
- `/app/backend/routes/refund_routes.py` - Refund request and approval
- `/app/backend/routes/invoice_pdf_routes.py` - PDF invoice generation
- `/app/backend/database.py` - MongoDB collections including invite_codes
- `/app/API_KEYS_GUIDE.md` - Production API key setup

## New API Endpoints (Jan 2026)
- `GET /api/provider/settings/business` - Get business settings
- `PUT /api/provider/settings/business` - Update business settings
- `POST /api/provider/settings/logo` - Upload logo
- `DELETE /api/provider/settings/logo` - Remove logo
- `GET /api/provider/settings/invoice-number` - Get next invoice number
- `POST /api/refunds/request` - Client requests refund
- `GET /api/refunds/my-requests` - Get user's refund requests
- `GET /api/refunds/pending` - Get pending refunds (provider)
- `POST /api/refunds/{id}/process` - Approve/reject refund
- `GET /api/invoices/{id}/pdf` - Download invoice PDF
- `GET /api/invoices/{id}/preview` - Preview invoice data
